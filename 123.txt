Create-PowerPlatformServiceConnection.ps1

[CmdletBinding()]
param(
    [Parameter(Mandatory = $true)]
    [string]$Organization,

    [Parameter(Mandatory = $true)]
    [string]$Project,

    [Parameter(Mandatory = $true)]
    [string]$PAT,

    [Parameter(Mandatory = $true)]
    [string]$ServiceConnectionName,

    [Parameter(Mandatory = $true)]
    [string]$ServicePrincipalId,

    [Parameter(Mandatory = $true)]
    [string]$ServicePrincipalKey,

    [Parameter(Mandatory = $true)]
    [string]$TenantId,

    [Parameter(Mandatory = $false)]
    [string]$ServerUrl = "https://api.powerplatform.com"
)

# Encode the PAT for Basic auth (username can be empty)
$base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(":$PAT"))

# Construct the service endpoint payload
$serviceEndpoint = @{
    name = $ServiceConnectionName
    type = "powerplatform"
    url  = $ServerUrl
    authorization = @{
        scheme = "ServicePrincipal"
        parameters = @{
            authenticationType   = "spnKey"
            serviceprincipalid   = $ServicePrincipalId
            serviceprincipalkey  = $ServicePrincipalKey
            tenantid             = $TenantId
        }
    }
    data = @{}
}

# Convert payload to JSON
$jsonBody = $serviceEndpoint | ConvertTo-Json -Depth 10

# Azure DevOps REST API endpoint
$apiUrl = "https://dev.azure.com/$Organization/$Project/_apis/serviceendpoint/endpoints?api-version=6.0-preview.4"

try {
    $response = Invoke-RestMethod -Uri $apiUrl `
                                  -Method Post `
                                  -Headers @{ Authorization = "Basic $base64AuthInfo" } `
                                  -ContentType "application/json" `
                                  -Body $jsonBody

    Write-Host "Service connection '$ServiceConnectionName' created successfully in project '$Project' of organization '$Organization'." -ForegroundColor Green
}
catch {
    Write-Host "Error creating service connection '$ServiceConnectionName':" -ForegroundColor Red
    Write-Error $_
}


main.tf

terraform {
  required_version = ">= 1.0.0"
}

variable "service_connection_params" {
  type = map(object({
    organization            = string
    project                 = string
    azure_devops_pat        = string
    service_connection_name = string
    service_principal_id    = string
    service_principal_key   = string
    tenant_id               = string
    server_url              = optional(string, "https://api.powerplatform.com")
  }))
  description = "Map of parameters for each Power Platform service connection"
}

resource "null_resource" "create_service_connection" {
  # for_each will create one resource per entry in the map
  for_each = var.service_connection_params

  provisioner "local-exec" {
    command = <<-EOT
      powershell -ExecutionPolicy Bypass -File ./Create-PowerPlatformServiceConnection.ps1 `
        -Organization "${each.value.organization}" `
        -Project "${each.value.project}" `
        -PAT "${each.value.azure_devops_pat}" `
        -ServiceConnectionName "${each.value.service_connection_name}" `
        -ServicePrincipalId "${each.value.service_principal_id}" `
        -ServicePrincipalKey "${each.value.service_principal_key}" `
        -TenantId "${each.value.tenant_id}" `
        -ServerUrl "${each.value.server_url}"
    EOT
  }
}


tfvars

service_connection_params = {
  "connection1" = {
    organization            = "YourOrg1"
    project                 = "YourProject1"
    azure_devops_pat        = "yourPAT1"
    service_connection_name = "PowerPlatformConnection1"
    service_principal_id    = "00000000-0000-0000-0000-000000000001"
    service_principal_key   = "superSecretKey1"
    tenant_id               = "11111111-1111-1111-1111-111111111111"
    server_url              = "https://org1.crm.dynamics.com"
  },
  "connection2" = {
    organization            = "YourOrg2"
    project                 = "YourProject2"
    azure_devops_pat        = "yourPAT2"
    service_connection_name = "PowerPlatformConnection2"
    service_principal_id    = "00000000-0000-0000-0000-000000000002"
    service_principal_key   = "superSecretKey2"
    tenant_id               = "22222222-2222-2222-2222-222222222222"
    server_url              = "https://org2.crm.dynamics.com"
  }
}
