pipeline {
    agent any
    
    parameters {
        string(name: 'deployment_type', description: 'Deployment type (qliksense or looker)', defaultValue: 'qliksense')
    }
    
    stages {
        stage("Deploy instances") {
            when {
                expression { params.stage == "run" }
            }
            steps {
                script {
                    def ansibleVarsFile = readFile('ansible_vars.json')
                    def ansibleVars = new groovy.json.JsonSlurper().parseText(ansibleVarsFile)
                    
                    ansibleVars.each { deployment ->
                        if (deployment[params.deployment_type]) {
                            def extraVars = deployment.DeployExtraVars.collect { key, value -> "$key='$value'" }.join(' ')
                            
                            sh """
                            ansibleTower(
                                towerserver: 'ALM ANSIBLE STAGE',
                                towercredentialsId: 'GFPD-CLOUD-DEV',
                                templatetype: 'job',
                                jobTemplate: '${deployment.deploy}',
                                towerloglevel: 'full',
                                inventory: '${params.fproject}',
                                verbose: true,
                                extraVars: [${extraVars}],
                                async: false
                            )
                            """
                        }
                    }
                }
            }
        }
    }
}
