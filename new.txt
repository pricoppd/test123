echo -e "\e[1;31mTerraform plan detected changes. Failing the stage.\e[0m"


- task: PowerShell@2
      displayName: Check Terraform plan changes
      inputs:
        targetType: 'inline'
        script: |
          $terraformOutput = Get-Content -Path '$(System.DefaultWorkingDirectory)/terraform-output.txt' -Raw
          if ($terraformOutput -like "*Terraform will perform*") {
            Write-Error "Terraform plan detected changes. Failing the stage."
            exit 1
          }


- powershell: |
    terraform show -json $(System.DefaultWorkingDirectory)/terraform-output.tfplan > $(System.DefaultWorkingDirectory)/terraform-output.txt
  displayName: 'Save Terraform Plan Output'

- task: PowerShell@2
  displayName: 'Check Node.js version'
  inputs:
    targetType: 'inline'
    script: |
      node --version


- task: Bash@3
  displayName: 'Check Terraform plan changes'
  inputs:
    targetType: 'inline'
    script: |
      terraformOutput=$(cat "$(System.DefaultWorkingDirectory)/terraform-output.txt")

      if [[ $terraformOutput == *"Terraform will perform"* ]]; then
        echo "Terraform plan detected changes. Failing the stage."
        exit 1
      fi


- task: Bash@3
      displayName: 'Check Terraform plan changes'
      inputs:
        targetType: 'inline'
        script: |
          terraformOutput=$(cat "$(System.DefaultWorkingDirectory)/terraform-output.txt")

          if [[ $terraformOutput == *"Terraform will perform"* ]]; then
            echo "Terraform plan detected changes. Failing the stage."
            exit 1
          ```
stages:
- stage: BashOnlyStage
  displayName: 'Bash Only Stage'
  jobs:
  - job: RunBashScript
    displayName: 'Run Bash Script'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Bash@3
      displayName: 'Run Bash Script'
      inputs:
        targetType: 'inline'
        script: |
          echo "Hello from Bash task!"
____________________________________________

terraformOutput=$(cat "$(System.DefaultWorkingDirectory)/tfplan")

          if [[ $terraformOutput == *"Terraform will perform"* ]]; then
            echo "Terraform plan detected changes. Failing the stage."
            exit 1
          else
            echo "No Terraform plan changes detected."
          fi

terraform show -no-color -json "$(Build.SourcesDirectory)/$(SourceRepositoryName)/tf.tfplan" > $(Build.ArtifactStagingDirectory)/terraform-output.txt


______________________________________________________________________________________________________

- script: |
    terraform show -no-color -json "$(Build.SourcesDirectory)/$(parameters.SourceRepositoryName)/tf.tfplan"
    terraform show -no-color -json "$(Build.SourcesDirectory)/$(parameters.SourceRepositoryName)/tf.tfplan" > $(System.DefaultWorkingDirectory)/terraform-output.txt

    # Check for changes and fail the stage if FailOnChanges is true
    if [[ $(terraform show -no-color -json "$(Build.SourcesDirectory)/$(parameters.SourceRepositoryName)/tf.tfplan") != "null" && $(parameters.FailOnChanges) == true ]]; then
        echo "Terraform plan detected changes. Failing the stage."
        exit 1
    fi
  displayName: 'Check the Terraform plan'
  workingDirectory: '$(Build.SourcesDirectory)/$(parameters.SourceRepositoryName)/env'


# Run Terraform plan and save the output to a file
terraform plan -out=tfplan

# Show the plan in text format and save it to a file
terraform show -no-color tfplan > tfplan.txt

# Check if the "No changes" message is present in the output
if ! grep -q "No changes. Your infrastructure matches the configuration." tfplan.txt; then
    echo "Terraform plan detected changes. Failing the stage."
    exit 1
else
    echo "No changes detected in the Terraform plan. Proceeding with the stage."
fi

if [[ ! $terraformOutput == *"No changes. Your infrastructure matches the configuration."* ]]; then
  echo "Terraform plan detected changes. Failing the stage."
  exit 1
fi
