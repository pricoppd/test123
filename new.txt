stage("Deploy test instance") {
    when {
        expression { params.stage_to_run == "deploy_test_instance" }
    }
    steps {
        script {
            def ansibleVarsFile = readFile('DeployApps.json')
            def ansibleVars = new groovy.json.JsonSlurper().parseText(ansibleVarsFile)
            
            def deployment = ansibleVars[params.deployment_type]
            if (deployment) {
                def extravars = deployment.DeployExtraVars.collect { key, value -> "$key='$value'" }.join(' ')
                
                ansibleTower(
                    towerServer: 'ALM_ANSIBLE STAGE',
                    towerCredentialsId: 'GFPD-CLOUD-DEV',
                    templateType: 'job',
                    jobTemplate: deployment.job_template_name, // Assuming job_template_name is a property in your JSON
                    towerloglevel: 'full', // Corrected log level
                    inventory: deployment.project, // Assuming project is a property in your JSON
                    verbose: true,
                    extraVars: extravars, // Using the constructed extravars
                    async: false
                )
            } else {
                echo "Deployment type '${params.deployment_type}' not found in JSON."
            }
        }
    }
}
